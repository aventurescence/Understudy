name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 1.2.3). Leave blank to auto-increment patch.'
        required: false
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-2022
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Determine version
      id: version
      shell: pwsh
      run: |
        # Get the latest tag
        $latestTag = git describe --tags --abbrev=0 2>$null
        $inputVersion = '${{ github.event.inputs.version }}'

        if ($inputVersion) {
          # Use the manually specified version
          $ver = $inputVersion.TrimStart('v')
        } elseif ($latestTag) {
          # Auto-increment patch from latest tag
          $ver = $latestTag.TrimStart('v')
          $parts = $ver.Split('.')
          # Increment patch (3rd component, or 2nd if only major.minor)
          if ($parts.Length -ge 3) {
            $parts[2] = [string]([int]$parts[2] + 1)
          } elseif ($parts.Length -eq 2) {
            $parts += '1'
          } else {
            $parts += @('0', '1')
          }
          $ver = $parts[0..2] -join '.'
        } else {
          # No tags exist yet, start at 1.0.0
          $ver = '1.0.0'
        }

        # Ensure 4-part version for Dalamud (X.Y.Z.W)
        $parts = $ver.Split('.')
        while ($parts.Length -lt 4) { $parts += '0' }
        $fullVersion = $parts[0..3] -join '.'
        $tagVersion = $parts[0..2] -join '.'

        echo "version=$fullVersion" >> $env:GITHUB_OUTPUT
        echo "tag=v$tagVersion" >> $env:GITHUB_OUTPUT
        echo "Resolved version: $fullVersion (tag: v$tagVersion)"

    - name: Check if tag already exists
      id: check_tag
      shell: pwsh
      run: |
        $tag = '${{ steps.version.outputs.tag }}'
        $exists = git tag -l $tag
        if ($exists) {
          echo "Tag $tag already exists, skipping release."
          echo "exists=true" >> $env:GITHUB_OUTPUT
        } else {
          echo "exists=false" >> $env:GITHUB_OUTPUT
        }

    - name: Setup .NET
      if: steps.check_tag.outputs.exists == 'false'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Download Dalamud
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        Invoke-WebRequest -Uri https://goatcorp.github.io/dalamud-distrib/latest.zip -OutFile latest.zip
        Expand-Archive -Force latest.zip "$env:AppData\XIVLauncher\addon\Hooks\dev"

    - name: Build
      if: steps.check_tag.outputs.exists == 'false'
      run: dotnet build Understudy/Understudy.sln --configuration Release -p:Version=${{ steps.version.outputs.version }}

    - name: Create Tag
      if: steps.check_tag.outputs.exists == 'false'
      run: |
        git tag ${{ steps.version.outputs.tag }}
        git push origin ${{ steps.version.outputs.tag }}

    - name: Create Release
      if: steps.check_tag.outputs.exists == 'false'
      uses: softprops/action-gh-release@v1
      with:
        files: Understudy/bin/Release/Understudy/latest.zip
        name: ${{ steps.version.outputs.tag }}
        tag_name: ${{ steps.version.outputs.tag }}
        body: |
          Release ${{ steps.version.outputs.tag }} (assembly version ${{ steps.version.outputs.version }})

    - name: Trigger Plugin Master Update
      if: steps.check_tag.outputs.exists == 'false' && success()
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ secrets.PAT }}
        repository: aventurescence/churinplugins
        event-type: update-pluginmaster
        client-payload: '{"name": "Understudy", "version": "${{ steps.version.outputs.tag }}", "download_url": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/latest.zip"}'
